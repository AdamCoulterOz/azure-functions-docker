trigger: none 
pr: none

schedules:
- cron: "0 * * * *"
  branches:
    include:
    - master
  always: true

pool:
  vmImage: ubuntu-18.04

steps:
  - bash: |
      sudo npm i -g azure-functions-core-tools@3 --unsafe-perm true
      latestVersion=`func --version`
      echo "latestVersion: ${latestVersion}"
      echo "##vso[task.setvariable variable=LatestVersion;]${latestVersion}" 
    displayName: Check the latest version 
  - bash: |
      set -e
      ImageName="mcr.microsoft.com/azure-functions/dotnet:3.0-dotnet3-core-tools"
      docker run $ImageName az --version
      CurrentVersion=`docker run $ImageName func --version`
      echo "Azure Functions Core Tools: Current: ${CurrentVersion} Latest: $(LatestVersion)"
      if [[ "$CurrentVersion" != "$LatestVersion" ]]; then
        echo "unmatch the Current and Latest version";
        echo "##vso[task.setvariable variable=UnmatchLatest;]true"                 
      fi
    displayName: DotNet 3.0 core-tools 
  - bash: |
      set -e
      ImageName="mcr.microsoft.com/azure-functions/node:3.0-core-tools"
      docker run $ImageName az --version
      CurrentVersion=`docker run $ImageName func --version`
      echo "Azure Functions Core Tools: Current: ${CurrentVersion} Latest: $(LatestVersion)"
      if [[ "$CurrentVersion" != "$LatestVersion" ]]; then
        echo "unmatch the Current and Latest version";
        echo "##vso[task.setvariable variable=UnmatchLatest;]true"                 
      fi
    displayName: Node core-tools 
  - bash: |
      set -e
      ImageName="mcr.microsoft.com/azure-functions/node:3.0-node10-core-tools"
      docker run $ImageName az --version
      CurrentVersion=`docker run $ImageName func --version`
      echo "Azure Functions Core Tools: Current: ${CurrentVersion} Latest: $(LatestVersion)"
      if [[ "$CurrentVersion" != "$LatestVersion" ]]; then
        echo "unmatch the Current and Latest version";
        echo "##vso[task.setvariable variable=UnmatchLatest;]true"                 
      fi
    displayName: Node10 core-tools 
  - bash: |
      set -e
      ImageName="mcr.microsoft.com/azure-functions/node:3.0-node12-core-tools"
      docker run $ImageName az --version
      CurrentVersion=`docker run $ImageName func --version`
      echo "Azure Functions Core Tools: Current: ${CurrentVersion} Latest: $(LatestVersion)"
      if [[ "$CurrentVersion" != "$LatestVersion" ]]; then
        echo "unmatch the Current and Latest version";
        echo "##vso[task.setvariable variable=UnmatchLatest;]true"                 
      fi
    displayName: Node12 core-tools 
  - bash: |
      set -e
      ImageName="mcr.microsoft.com/azure-functions/java:3.0-java8-core-tools"
      docker run $ImageName az --version
      CurrentVersion=`docker run $ImageName func --version`
      echo "Azure Functions Core Tools: Current: ${CurrentVersion} Latest: $(LatestVersion)"
      if [[ "$CurrentVersion" != "$LatestVersion" ]]; then
        echo "unmatch the Current and Latest version";
        echo "##vso[task.setvariable variable=UnmatchLatest;]true"                 
      fi
    displayName: java8 core-tools 
  - bash: |
      set -e
      ImageName="mcr.microsoft.com/azure-functions/java:3.0-java11-core-tools"
      docker run $ImageName az --version
      CurrentVersion=`docker run $ImageName func --version`
      echo "Azure Functions Core Tools: Current: ${CurrentVersion} Latest: $(LatestVersion)"
      if [[ "$CurrentVersion" != "$LatestVersion" ]]; then
        echo "unmatch the Current and Latest version";
        echo "##vso[task.setvariable variable=UnmatchLatest;]true"                 
      fi
    displayName: java11 core-tools 
  - bash: |
      set -e
      ImageName="mcr.microsoft.com/azure-functions/python:3.0-python3.8-core-tools"
      docker run $ImageName az --version
      CurrentVersion=`docker run $ImageName func --version`
      echo "Azure Functions Core Tools: Current: ${CurrentVersion} Latest: $(LatestVersion)"
      if [[ "$CurrentVersion" != "$LatestVersion" ]]; then
        echo "unmatch the Current and Latest version";
        echo "##vso[task.setvariable variable=UnmatchLatest;]true"                 
      fi
    displayName: python3.8 core-tools 
  - bash: |
      set -e
      ImageName="mcr.microsoft.com/azure-functions/powershell:3.0-powershell6-core-tools"
      docker run $ImageName az --version
      CurrentVersion=`docker run $ImageName func --version`
      echo "Azure Functions Core Tools: Current: ${CurrentVersion} Latest: $(LatestVersion)"
      if [[ "$CurrentVersion" != "$LatestVersion" ]]; then
        echo "unmatch the Current and Latest version";
        echo "##vso[task.setvariable variable=UnmatchLatest;]true"                 
      fi
    displayName: PowerShell6 core-tools   
  - bash: |
      set -e
      ImageName="mcr.microsoft.com/azure-functions/powershell:3.0-powershell7-core-tools"
      docker run $ImageName az --version
      CurrentVersion=`docker run $ImageName func --version`
      echo "Azure Functions Core Tools: Current: ${CurrentVersion} Latest: $(LatestVersion)"
      if [[ "$CurrentVersion" != "$LatestVersion" ]]; then
        echo "unmatch the Current and Latest version";
        echo "##vso[task.setvariable variable=UnmatchLatest;]true"                 
      fi
    displayName: PowerShell7 core-tools
  - task: AzureCLI@2
    inputs:
      azureSubscription: 'Private Test Sub TSUSHI(4f4eb302-5f51-49ca-bba0-a87a8d3875be)'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        ./update_status.sh -f azure-functions-core-tools.json -s 2 -n "Core Tools Image"
    condition: failed()
    displayName: Update Status (Failure)
  - task: AzureCLI@2
    inputs:
      azureSubscription: 'Private Test Sub TSUSHI(4f4eb302-5f51-49ca-bba0-a87a8d3875be)'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        status=0 # Success
        if [[ ! -z "$(UnmatchLatest)" ]]; then
          echo "Warning detected"
          status=1 
        fi
        ./update_status.sh -f azure-functions-core-tools.json -s $status -n "Core Tools Image"
    condition: succeeded()
    displayName: Update Status (Success or Warning)


